<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekod Prestasi Murid</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { 
            background: linear-gradient(135deg, #2563EB 0%, #4F46E5 100%);
            color: white;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 28px; font-weight: 700; }
        .content { padding: 24px; }
        .section { margin-bottom: 24px; }
        .label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .input-group { display: flex; gap: 8px; }
        input[type="text"] {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 14px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #2563EB; color: white; }
        .btn-primary:hover { background: #1D4ED8; }
        .btn-success { background: #10B981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-refresh { background: rgba(255,255,255,0.2); color: white; }
        .btn-refresh:hover { background: rgba(255,255,255,0.3); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .class-btn {
            padding: 12px;
            background: #F3F4F6;
            border: 2px solid transparent;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .class-btn:hover { background: #E5E7EB; }
        .class-btn.active { 
            background: #2563EB;
            color: white;
            border-color: #1D4ED8;
            transform: scale(1.05);
        }
        .tabs { display: flex; gap: 8px; border-bottom: 2px solid #E5E7EB; margin-bottom: 24px; }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            font-weight: 600;
            color: #6B7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab.active {
            color: #2563EB;
            border-bottom-color: #2563EB;
        }
        .student-list { display: flex; flex-direction: column; gap: 8px; }
        .student-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .student-item:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .student-bil {
            min-width: 32px;
            font-weight: 700;
            color: #2563EB;
            font-size: 16px;
        }
        .student-name { flex: 1; color: #1F2937; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        thead { background: linear-gradient(135deg, #3B82F6 0%, #6366F1 100%); }
        th { padding: 12px; text-align: left; color: white; font-weight: 600; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #E5E7EB; }
        tr:hover { background: #F9FAFB; }
        .score-input {
            width: 100%;
            padding: 8px;
            text-align: center;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
        }
        .score-input:focus {
            outline: none;
            border-color: #2563EB;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6B7280;
        }
        .empty-icon { font-size: 64px; margin-bottom: 16px; }
        .spinner { 
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .gray-box {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>üìö Sistem Rekod Prestasi Murid</h1>
                <button class="btn btn-refresh" onclick="refreshData()">
                    <span id="refreshIcon">üîÑ</span> Refresh
                </button>
            </div>

            <div class="content">
                <!-- Add Class -->
                <div class="section">
                    <label class="label">Tambah Kelas Baru</label>
                    <div class="input-group">
                        <input type="text" id="newClassInput" placeholder="Nama kelas (cth: 5 Amanah)">
                        <button class="btn btn-success" onclick="addClass()">‚ûï Tambah Kelas</button>
                    </div>
                </div>

                <!-- Classes List -->
                <div class="section">
                    <label class="label">Pilih Kelas</label>
                    <div id="classesList" class="grid">
                        <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #6B7280;">
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div id="tabsSection" class="hidden">
                    <div class="tabs">
                        <button class="tab active" id="studentsTab" onclick="switchTab('students')">
                            üë• Senarai Murid
                        </button>
                        <button class="tab" id="activityTab" onclick="switchTab('activity')">
                            üìÖ Aktiviti Harian
                        </button>
                    </div>
                </div>

                <!-- Students Tab -->
                <div id="studentsContent" class="hidden">
                    <div class="section">
                        <label class="label">Tambah Murid</label>
                        <div class="input-group">
                            <input type="text" id="newStudentInput" placeholder="Nama murid">
                            <button class="btn btn-success" onclick="addStudent()">‚ûï Tambah Murid</button>
                        </div>
                    </div>

                    <div class="gray-box">
                        <label class="label" style="margin-bottom: 12px;">
                            Senarai Murid (<span id="studentCount">0</span>)
                        </label>
                        <div id="studentsList" class="student-list"></div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div id="activityContent" class="hidden">
                    <div class="section">
                        <label class="label">Tambah Aktiviti Baru</label>
                        <div class="input-group">
                            <input type="text" id="newActivityInput" placeholder="Nama aktiviti (cth: Ujian Matematik)">
                            <button class="btn btn-success" onclick="addActivity()">‚ûï Tambah Aktiviti</button>
                        </div>
                    </div>

                    <div class="gray-box">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <label class="label" style="margin: 0;">Rekod Aktiviti</label>
                            <button id="saveScoresBtn" class="btn btn-primary hidden" onclick="saveScores()">
                                üíæ Simpan Markah (<span id="scoreCount">0</span>)
                            </button>
                        </div>
                        <div id="activitiesTable" class="table-container"></div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state">
                    <div class="empty-icon">üë•</div>
                    <p style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">Pilih kelas untuk bermula</p>
                    <p style="font-size: 14px;">Klik pada butang kelas di atas</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedClass = null;
        let students = [];
        let activities = [];
        let scores = {};

        window.onload = function() {
            loadClasses();
        };

        function loadClasses() {
            showSpinner();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideSpinner();
                    const container = document.getElementById('classesList');
                    if (!result.classes || result.classes.length === 0) {
                        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #6B7280;">Tiada kelas lagi. Tambah kelas baru untuk bermula.</div>';
                    } else {
                        container.innerHTML = result.classes.map(cls => 
                            `<button class="class-btn ${selectedClass === cls ? 'active' : ''}" onclick="selectClass('${cls.replace(/'/g, "\\'")}')">${cls}</button>`
                        ).join('');
                    }
                })
                .withFailureHandler(function(error) {
                    hideSpinner();
                    alert('‚ùå Ralat: ' + error.message);
                })
                .getClassesData();
        }

        function addClass() {
            const input = document.getElementById('newClassInput');
            const className = input.value.trim();
            if (!className) {
                alert('‚ö†Ô∏è Sila masukkan nama kelas');
                return;
            }

            showSpinner();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideSpinner();
                    if (result.success) {
                        input.value = '';
                        loadClasses();
                        alert('‚úÖ Kelas "' + className + '" berjaya ditambah!');
                    }
                })
                .withFailureHandler(function(error) {
                    hideSpinner();
                    alert('‚ùå Ralat: ' + error.message);
                })
                .addClassData(className);
        }

        function selectClass(className) {
            selectedClass = className;
            loadClasses();
            loadStudents(className);
            document.getElementById('tabsSection').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            switchTab('students');
        }

        function loadStudents(className) {
            showSpinner();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideSpinner();
                    students = result.students || [];
                    activities = result.activities || [];
                    
                    document.getElementById('studentCount').textContent = students.length;
                    
                    const container = document.getElementById('studentsList');
                    if (students.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6B7280;">Tiada murid lagi. Tambah murid baru.</div>';
                    } else {
                        container.innerHTML = students.map(s => `
                            <div class="student-item">
                                <span class="student-bil">${s.bil}</span>
                                <span class="student-name" id="student-${s.row}">${s.name}</span>
                                <input type="text" id="edit-${s.row}" value="${s.name}" class="hidden" 
                                    style="flex: 1; padding: 8px; border: 1px solid #3B82F6; border-radius: 6px;"
                                    onblur="saveStudentEdit(${s.row})"
                                    onkeypress="if(event.key==='Enter') saveStudentEdit(${s.row})">
                                <button class="btn btn-primary" style="padding: 8px 12px;" onclick="editStudent(${s.row})">‚úèÔ∏è</button>
                            </div>
                        `).join('');
                    }
                    
                    renderActivitiesTable();
                })
                .withFailureHandler(function(error) {
                    hideSpinner();
                    alert('‚ùå Ralat: ' + error.message);
                })
                .getStudentsData(className);
        }

        function editStudent(row) {
            document.getElementById('student-' + row).classList.add('hidden');
            const input = document.getElementById('edit-' + row);
            input.classList.remove('hidden');
            input.focus();
        }

        function saveStudentEdit(row) {
            const input = document.getElementById('edit-' + row);
            const newName = input.value.trim();
            if (!newName) return;

            showSpinner();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideSpinner();
                    if (result.success) {
                        loadStudents(selectedClass);
                        alert('‚úÖ Nama murid berjaya dikemaskini!');
                    }
                })
                .withFailureHandler(function(error) {
                    hideSpinner();
                    alert('‚ùå Ralat: ' + error.message);
                })
                .updateStudentData(selectedClass, row, newName);
        }

        function addStudent() {
            const input = document.getElementById('newStudentInput');
            const studentName = input.value.trim();
            if (!studentName) {
                alert('‚ö†Ô∏è Sila masukkan nama murid');
                return;
            }
            if (!selectedClass) {
                alert('‚ö†Ô∏è Sila pilih kelas terlebih dahulu');
                return;
            }

            showSpinner();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideSpinner();
                    if (result.success) {
                        input.value = '';
                        loadStudents(selectedClass);
                        alert('‚úÖ Murid "' + studentName + '" berjaya ditambah!');
                    }
                })
                .withFailureHandler(function(error) {
                    hideSpinner();
                    alert('‚ùå Ralat: ' + error.message);
                })
                .addStudentData(selectedClass, studentName);
        }

        function addActivity() {
            const input = document.getElementById('newActivityInput');
            const activityName = input.value.trim();
            if (!activityName) {
                alert('‚ö†Ô∏è Sila masukkan nama aktiviti');
                return;
            }
            if (!selectedClass) {
                alert('‚ö†Ô∏è Sila pilih kelas terlebih dahulu');
                return;
            }

            showSpinner();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideSpinner();
                    if (result.success) {
                        input.value = '';
                        loadStudents(selectedClass);
                        alert('‚úÖ Aktiviti "' + activityName + '" berjaya ditambah!');
                    }
                })
                .withFailureHandler(function(error) {
                    hideSpinner();
                    alert('‚ùå Ralat: ' + error.message);
                })
                .addActivityData(selectedClass, activityName);
        }

        function renderActivitiesTable() {
            const container = document.getElementById('activitiesTable');
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <p style="font-size: 18px; font-weight: 600;">Tiada aktiviti lagi</p>
                        <p style="font-size: 14px;">Tambah aktiviti baru untuk mula merekod prestasi murid</p>
                    </div>
                `;
                return;
            }
            
            const headers = activities.map(act => `<th style="text-align: center; min-width: 120px;">${act}</th>`).join('');
            const rows = students.map(student => {
                const cells = activities.map((_, idx) => {
                    const key = student.row + '-' + idx;
                    const value = scores[key] !== undefined ? scores[key] : (student.scores[idx] || '');
                    return `<td><input type="text" class="score-input" value="${value}" onchange="updateScore('${key}', this.value)" placeholder="0"></td>`;
                }).join('');
                
                return `<tr><td style="font-weight: 600; color: #1F2937;">${student.bil}</td><td style="color: #1F2937;">${student.name}</td>${cells}</tr>`;
            }).join('');
            
            container.innerHTML = `
                <table>
                    <thead><tr><th>Bil</th><th>Nama</th>${headers}</tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function updateScore(key, value) {
            scores[key] = value;
            const count = Object.keys(scores).length;
            document.getElementById('scoreCount').textContent = count;
            document.getElementById('saveScoresBtn').classList.toggle('hidden', count === 0);
        }

        function saveScores() {
            if (Object.keys(scores).length === 0) return;

            showSpinner();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideSpinner();
                    if (result.success) {
                        scores = {};
                        document.getElementById('scoreCount').textContent = '0';
                        document.getElementById('saveScoresBtn').classList.add('hidden');
                        alert('‚úÖ Markah berjaya disimpan ke Google Sheet!');
                        loadStudents(selectedClass);
                    }
                })
                .withFailureHandler(function(error) {
                    hideSpinner();
                    alert('‚ùå Ralat: ' + error.message);
                })
                .saveScoresData(selectedClass, scores);
        }

        function switchTab(tab) {
            const studentsTab = document.getElementById('studentsTab');
            const activityTab = document.getElementById('activityTab');
            const studentsContent = document.getElementById('studentsContent');
            const activityContent = document.getElementById('activityContent');
            
            if (tab === 'students') {
                studentsTab.classList.add('active');
                activityTab.classList.remove('active');
                studentsContent.classList.remove('hidden');
                activityContent.classList.add('hidden');
            } else {
                activityTab.classList.add('active');
                studentsTab.classList.remove('active');
                activityContent.classList.remove('hidden');
                studentsContent.classList.add('hidden');
            }
        }

        function refreshData() {
            if (selectedClass) {
                loadStudents(selectedClass);
            } else {
                loadClasses();
            }
        }

        function showSpinner() {
            document.getElementById('refreshIcon').classList.add('spinner');
        }

        function hideSpinner() {
            document.getElementById('refreshIcon').classList.remove('spinner');
        }
    </script>
</body>
</html>
